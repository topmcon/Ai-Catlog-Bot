name: Deploy to Self-Hosted Server

on:
  push:
    branches:
      - production
  workflow_dispatch:  # Manual trigger

env:
  SERVER_HOST: 198.211.105.43
  DEPLOY_PATH: /var/www/catalogbot

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}
      
      - name: Add Server to Known Hosts
        run: |
          ssh-keyscan -H ${{ env.SERVER_HOST }} >> ~/.ssh/known_hosts
      
      - name: Deploy Backend
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ env.SERVER_HOST }} << 'ENDSSH'
            cd ${{ env.DEPLOY_PATH }}
            
            # Pull latest code from production branch
            git pull origin production
            
            # Restart backend service (Docker already running)
            docker restart catalogbot-api
            echo "âœ… Backend restarted successfully!"
          ENDSSH
  
  deploy-frontend:
    # needs: test  # Disabled until tests are fixed
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Build Frontend
        working-directory: frontend
        run: |
          npm install
          npm run build
      
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}
      
      - name: Deploy Frontend to Server
        run: |
          ssh-keyscan -H ${{ env.SERVER_HOST }} >> ~/.ssh/known_hosts
          
          # Create tarball
          cd frontend/dist
          tar -czf frontend.tar.gz *
          
          # Upload and extract
          scp frontend.tar.gz ${{ secrets.SERVER_USER }}@${{ env.SERVER_HOST }}:/tmp/
          
          ssh ${{ secrets.SERVER_USER }}@${{ env.SERVER_HOST }} << 'ENDSSH'
            sudo mkdir -p /var/www/html
            cd /var/www/html
            sudo tar -xzf /tmp/frontend.tar.gz
            sudo chown -R www-data:www-data /var/www/html
            rm /tmp/frontend.tar.gz
            echo "âœ… Frontend deployed successfully!"
          ENDSSH
  
  notify:
    needs: [deploy-backend, deploy-frontend]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Deployment Status
        run: |
          if [ "${{ needs.deploy-backend.result }}" == "success" ] && [ "${{ needs.deploy-frontend.result }}" == "success" ]; then
            echo "ðŸŽ‰ Deployment to ${{ env.SERVER_HOST }} completed successfully!"
          else
            echo "âŒ Deployment failed. Check logs above."
            exit 1
          fi
